<script>

// ===============================
// SNOWSKYE AI FULL FRONTEND
// WITH CHAT HISTORY PERSISTENCE
// ===============================


// ===============================
// USER ID SYSTEM
// ===============================
function getUserId(){

  let userId =
    localStorage.getItem("snowskye_user_id");

  if(!userId){

    userId =
      "user_" +
      Date.now() +
      "_" +
      Math.random().toString(36).substring(2,10);

    localStorage.setItem(
      "snowskye_user_id",
      userId
    );

  }

  return userId;

}

const userId = getUserId();


// ===============================
// CHAT HISTORY SYSTEM
// ===============================
function saveChat(role,text){

  let history =
    JSON.parse(
      localStorage.getItem("snowskye_chat_history")
    ) || [];

  history.push({
    role:role,
    text:text
  });

  localStorage.setItem(
    "snowskye_chat_history",
    JSON.stringify(history)
  );

}


function loadChat(){

  let history =
    JSON.parse(
      localStorage.getItem("snowskye_chat_history")
    ) || [];

  history.forEach(msg=>{

    addMessage(
      msg.text,
      msg.role
    );

  });

}


function clearChat(){

  localStorage.removeItem(
    "snowskye_chat_history"
  );

  document.getElementById("chat").innerHTML = "";

}


// ===============================
// SOUND
// ===============================
const sound =
new Audio(
"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
);


// ===============================
// TOGGLE CHAT
// ===============================
function toggleChat(){

  document
  .getElementById("chatContainer")
  .classList
  .toggle("active");

}


// ===============================
// ADD MESSAGE
// ===============================
function addMessage(text,type){

  const chat =
    document.getElementById("chat");

  const msg =
    document.createElement("div");

  msg.className =
    "message " + type;

  msg.innerText =
    text;

  chat.appendChild(msg);

  chat.scrollTop =
    chat.scrollHeight;

}


// ===============================
// TYPING INDICATOR
// ===============================
function showTyping(){

  const chat =
    document.getElementById("chat");

  const typing =
    document.createElement("div");

  typing.className =
    "message bot";

  typing.id =
    "typing";

  typing.innerHTML =
  `<div class="typing">
    <span></span>
    <span></span>
    <span></span>
  </div>`;

  chat.appendChild(typing);

}


function removeTyping(){

  const t =
    document.getElementById("typing");

  if(t) t.remove();

}


// ===============================
// SEND MESSAGE
// ===============================
let sending = false;

async function send(){

  if(sending) return;

  const input =
    document.getElementById("input");

  const text =
    input.value.trim();

  if(!text) return;

  sending = true;

  addMessage(text,"user");

  saveChat("user",text);

  input.value = "";

  showTyping();

  try{

    const res =
      await fetch("/chat",{

        method:"POST",

        headers:{
          "Content-Type":"application/json"
        },

        body:JSON.stringify({

          message:text,

          userId:userId

        })

      });

    const data =
      await res.json();

    removeTyping();

    addMessage(data.reply,"bot");

    saveChat("bot",data.reply);

    sound.play();

  }catch{

    removeTyping();

    addMessage("Server error","bot");

  }

  sending = false;

}


// ===============================
// ENTER KEY SUPPORT
// ===============================
document
.getElementById("input")
.addEventListener(
"keydown",
e=>{
  if(e.key==="Enter")
    send();
}
);


// ===============================
// START SESSION OR LOAD HISTORY
// ===============================
async function start(){

  let history =
    localStorage.getItem(
      "snowskye_chat_history"
    );

  if(history){

    loadChat();

    return;

  }

  showTyping();

  try{

    const res =
      await fetch("/chat",{

        method:"POST",

        headers:{
          "Content-Type":"application/json"
        },

        body:JSON.stringify({

          message:"start",

          userId:userId

        })

      });

    const data =
      await res.json();

    removeTyping();

    addMessage(data.reply,"bot");

    saveChat("bot",data.reply);

  }catch{

    removeTyping();

    addMessage(
      "Assistant connected.",
      "bot"
    );

  }

}


// ===============================
// INITIALIZE
// ===============================
start();

</script>
