<script>

// ===============================
// SNOWSKYE AI FRONTEND FIXED
// ===============================

// Generate persistent user ID
function getUserId(){

  let userId = localStorage.getItem("snowskye_user_id");

  if(!userId){

    userId =
      "user_" +
      Date.now() +
      "_" +
      Math.random().toString(36).substring(2,10);

    localStorage.setItem("snowskye_user_id",userId);

    console.log("Created new userId:",userId);

  }

  return userId;

}

const userId = getUserId();

let sending = false;

const sound =
new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");


// ===============================
// Toggle Chat
// ===============================
function toggleChat(){

  document
    .getElementById("chatContainer")
    .classList
    .toggle("active");

}


// ===============================
// Add Message
// ===============================
function addMessage(text,type){

  const chat =
    document.getElementById("chat");

  const msg =
    document.createElement("div");

  msg.className =
    "message " + type;

  msg.innerText = text;

  chat.appendChild(msg);

  chat.scrollTop =
    chat.scrollHeight;

}


// ===============================
// Typing Indicator
// ===============================
function showTyping(){

  const chat =
    document.getElementById("chat");

  const typing =
    document.createElement("div");

  typing.className =
    "message bot";

  typing.id =
    "typing";

  typing.innerHTML =
  `<div class="typing">
    <span></span>
    <span></span>
    <span></span>
  </div>`;

  chat.appendChild(typing);

  chat.scrollTop =
    chat.scrollHeight;

}


function removeTyping(){

  const t =
    document.getElementById("typing");

  if(t) t.remove();

}


// ===============================
// Send Message (FIXED)
// ===============================
async function send(){

  if(sending) return;

  const input =
    document.getElementById("input");

  const text =
    input.value.trim();

  if(!text) return;

  sending = true;

  addMessage(text,"user");

  input.value = "";

  showTyping();

  try{

    const res =
      await fetch("/chat",{

        method:"POST",

        headers:{
          "Content-Type":"application/json"
        },

        body:JSON.stringify({

          message:text,

          userId:userId   // âœ… CRITICAL FIX

        })

      });

    const data =
      await res.json();

    removeTyping();

    addMessage(data.reply,"bot");

    sound.play();

  }catch{

    removeTyping();

    addMessage("Server error","bot");

  }

  sending = false;

}


// ===============================
// ENTER KEY SUPPORT
// ===============================
document
.getElementById("input")
.addEventListener("keydown",e=>{

  if(e.key==="Enter")
    send();

});


// ===============================
// START SESSION (FIXED)
// ===============================
async function startSession(){

  showTyping();

  try{

    const res =
      await fetch("/chat",{

        method:"POST",

        headers:{
          "Content-Type":"application/json"
        },

        body:JSON.stringify({

          message:"start",

          userId:userId   // âœ… CRITICAL FIX

        })

      });

    const data =
      await res.json();

    removeTyping();

    addMessage(data.reply,"bot");

  }catch{

    removeTyping();

    addMessage(
      "Hi ðŸ‘‹ I'm Snowskye AI Assistant.",
      "bot"
    );

  }

}


// Start automatically
startSession();

</script>
