<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SnowSkye AI</title>

<style>

body{
font-family: Arial;
background:#f4f6fb;
margin:0;
}

/* Floating button */
#toggleBtn{
position:fixed;
bottom:20px;
right:20px;
width:60px;
height:60px;
border-radius:50%;
background:#2563eb;
color:white;
border:none;
font-size:24px;
cursor:pointer;
box-shadow:0 4px 12px rgba(0,0,0,0.3);
z-index:9999;
}

/* Chat box */
#chatBox{
position:fixed;
bottom:90px;
right:20px;
width:350px;
height:500px;
background:#0f172a;
border-radius:12px;
display:none;
flex-direction:column;
overflow:hidden;
box-shadow:0 8px 25px rgba(0,0,0,0.3);
z-index:9999;
}

/* Mobile FULLSCREEN */
@media (max-width:600px){

#chatBox{
width:100%;
height:100%;
bottom:0;
right:0;
border-radius:0;
}

#toggleBtn{
bottom:15px;
right:15px;
}

}

/* Header */
#header{
background:#2563eb;
color:white;
padding:12px;
display:flex;
justify-content:space-between;
align-items:center;
}

#headerLeft{
display:flex;
align-items:center;
gap:10px;
font-weight:bold;
}

#closeBtn{
background:none;
border:none;
color:white;
font-size:22px;
cursor:pointer;
}

#logo{
width:30px;
height:30px;
border-radius:50%;
}

/* Messages */
#messages{
flex:1;
padding:10px;
overflow-y:auto;
}

.msg{
margin:8px 0;
padding:10px;
border-radius:10px;
max-width:80%;
}

.user{
background:#2563eb;
color:white;
margin-left:auto;
}

.bot{
background:#1e293b;
color:white;
}

.typing{
font-style:italic;
opacity:0.7;
}

/* Input */
#inputArea{
display:flex;
border-top:1px solid #1e293b;
}

#input{
flex:1;
padding:12px;
border:none;
outline:none;
font-size:16px;
}

button{
border:none;
padding:12px;
cursor:pointer;
}

#mic{
background:#10b981;
color:white;
}

#send{
background:#2563eb;
color:white;
}

</style>

</head>
<body>


<button id="toggleBtn">ðŸ’¬</button>


<div id="chatBox">

<div id="header">

<div id="headerLeft">
<img id="logo" src="/image/logo.png">
SnowSkye AI
</div>

<button id="closeBtn">âœ•</button>

</div>

<div id="messages"></div>

<div id="inputArea">
<input id="input" placeholder="Type message...">
<button id="mic">ðŸŽ¤</button>
<button id="send">Send</button>
</div>

</div>



<script>

// ==========================
// CONFIG (AUTO-DETECT RENDER)
// ==========================

const API_URL =
window.location.hostname === "localhost"
? "http://localhost:3000/chat"
: "/chat";


// ==========================
// ELEMENTS
// ==========================

const toggleBtn = document.getElementById("toggleBtn");
const chatBox = document.getElementById("chatBox");
const closeBtn = document.getElementById("closeBtn");
const messages = document.getElementById("messages");
const input = document.getElementById("input");

let welcomed = false;
let isSending = false;


// ==========================
// SESSION ID (persistent)
// ==========================

let sessionId =
localStorage.getItem("snowskye_session");

if(!sessionId){

sessionId =
crypto.randomUUID();

localStorage.setItem(
"snowskye_session",
sessionId
);

}


// ==========================
// TOGGLE CHAT
// ==========================

toggleBtn.onclick = () => {

if(chatBox.style.display === "flex"){

chatBox.style.display = "none";

}else{

chatBox.style.display = "flex";

if(!welcomed){

welcomeMessage();
welcomed = true;

}

}

};

closeBtn.onclick = () => {

chatBox.style.display = "none";

};


// ==========================
// WELCOME MESSAGE
// ==========================

function welcomeMessage(){

setTimeout(()=>{

const text =
"Hello ðŸ‘‹ I'm SnowSkye AI. How can I help you today?";

addMessage(text,"bot");
speak(text);

},500);

}


// ==========================
// ADD MESSAGE
// ==========================

function addMessage(text,type){

const div =
document.createElement("div");

div.className =
"msg " + type;

div.innerText =
text;

messages.appendChild(div);

messages.scrollTop =
messages.scrollHeight;

}


// ==========================
// TYPING INDICATOR
// ==========================

function showTyping(){

removeTyping();

const div =
document.createElement("div");

div.className =
"msg bot typing";

div.id = "typing";

div.innerText =
"SnowSkye AI is typing...";

messages.appendChild(div);

}

function removeTyping(){

const typing =
document.getElementById("typing");

if(typing)
typing.remove();

}


// ==========================
// NATURAL HUMAN VOICE ENGINE (FINAL)
// ==========================

let selectedVoice = null;

function loadVoice(){

const voices = speechSynthesis.getVoices();

// Best natural voices priority
selectedVoice =
voices.find(v => v.name.includes("Google US English")) ||
voices.find(v => v.name.includes("Microsoft Jenny")) ||
voices.find(v => v.name.includes("Microsoft Aria")) ||
voices.find(v => v.name.includes("Samantha")) ||
voices.find(v => v.lang === "en-US") ||
voices[0];

}

speechSynthesis.onvoiceschanged = loadVoice;
loadVoice();


// ==========================
// CLEAN TEXT FOR SPEECH
// ==========================

function cleanTextForSpeech(text){

return text

// Remove emojis completely
.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, "")

// Remove markdown (*, #, etc)
.replace(/[*_#`~]/g,"")

// Remove special symbols
.replace(/[^\w\s.,!?']/g, "")

// Add pauses after punctuation
.replace(/\./g, ". ")
.replace(/\!/g, "! ")
.replace(/\?/g, "? ")

// Fix spacing
.replace(/\s+/g, " ")
.trim();

}


// ==========================
// SPEAK FUNCTION
// ==========================

function speak(text){

try{

if(!text) return;

speechSynthesis.cancel();

const cleanText = cleanTextForSpeech(text);

const speech = new SpeechSynthesisUtterance(cleanText);

speech.voice = selectedVoice;

// MOST NATURAL HUMAN SETTINGS
speech.rate = 0.92;     // slower, clearer
speech.pitch = 1.0;     // normal human pitch
speech.volume = 1;

speechSynthesis.speak(speech);

}catch(err){

console.log("Speech error:", err);

}

}

// ==========================
// BACKUP REPLY
// ==========================

function backupReply(){

const reply =
"I'm having trouble responding right now. Please try again.";

addMessage(reply,"bot");

speak(reply);

}


// ==========================
// SEND MESSAGE
// ==========================

async function sendMessage(){

if(isSending) return;

const text =
input.value.trim();

if(!text) return;

isSending = true;

addMessage(text,"user");

input.value="";

showTyping();

try{

const controller =
new AbortController();

const timeout =
setTimeout(
()=>controller.abort(),
20000
);

const res =
await fetch(API_URL,{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

message:text,
sessionId,
apiKey: "sk-55c2d0e8-08b3-44af-aa9c-3329efacdcd2"

}),

signal:
controller.signal

});

clearTimeout(timeout);

if(!res.ok)
throw new Error();

const data =
await res.json();

removeTyping();

if(!data.reply){

backupReply();

}else{

addMessage(
data.reply,
"bot"
);

speak(data.reply);

}

}catch{

removeTyping();

backupReply();

}

isSending = false;

}


// ==========================
// BUTTON EVENTS
// ==========================

document
.getElementById("send")
.onclick =
sendMessage;

input.addEventListener(
"keypress",
(e)=>{
if(e.key==="Enter")
sendMessage();
});


// ==========================
// VOICE INPUT
// ==========================

document
.getElementById("mic")
.onclick = ()=>{

const SpeechRecognition =
window.SpeechRecognition ||
window.webkitSpeechRecognition;

if(!SpeechRecognition){

alert(
"Voice recognition not supported"
);

return;

}

const recognition =
new SpeechRecognition();

recognition.lang="en-US";

recognition.start();

recognition.onresult =
(event)=>{

input.value =
event.results[0][0].transcript;

sendMessage();

};

};

</script>

</body>
</html>
