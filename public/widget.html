(function () {

  // ============================
  // GET API KEY
  // ============================

  const script = document.currentScript;
  const apiKey = script.getAttribute("data-api-key");

  if (!apiKey) {
    console.error("SnowSkye: Missing API key");
    return;
  }

  const API_URL = "https://lead-chatbot-gti5.onrender.com";

  // ============================
  // CREATE CHAT BUTTON
  // ============================

  const button = document.createElement("div");

  button.innerHTML = "ðŸ’¬";

  button.style.position = "fixed";
  button.style.bottom = "20px";
  button.style.right = "20px";
  button.style.width = "60px";
  button.style.height = "60px";
  button.style.background = "#2563eb";
  button.style.color = "white";
  button.style.borderRadius = "50%";
  button.style.display = "flex";
  button.style.alignItems = "center";
  button.style.justifyContent = "center";
  button.style.fontSize = "24px";
  button.style.cursor = "pointer";
  button.style.zIndex = "999999";

  document.body.appendChild(button);


  // ============================
  // CREATE CHAT BOX
  // ============================

  const box = document.createElement("div");

  box.style.position = "fixed";
  box.style.bottom = "90px";
  box.style.right = "20px";
  box.style.width = "300px";
  box.style.height = "400px";
  box.style.background = "white";
  box.style.borderRadius = "10px";
  box.style.boxShadow = "0 0 15px rgba(0,0,0,0.2)";
  box.style.display = "none";
  box.style.flexDirection = "column";
  box.style.zIndex = "999999";

  document.body.appendChild(box);


  // ============================
  // HEADER
  // ============================

  const header = document.createElement("div");

  header.innerHTML = "SnowSkye AI";

  header.style.background = "#2563eb";
  header.style.color = "white";
  header.style.padding = "10px";
  header.style.fontWeight = "bold";

  box.appendChild(header);


  // ============================
  // MESSAGES
  // ============================

  const messages = document.createElement("div");

  messages.style.flex = "1";
  messages.style.padding = "10px";
  messages.style.overflowY = "auto";

  box.appendChild(messages);


  // ============================
  // INPUT AREA
  // ============================

  const inputArea = document.createElement("div");

  inputArea.style.display = "flex";

  const input = document.createElement("input");

  input.placeholder = "Type message...";
  input.style.flex = "1";
  input.style.border = "none";
  input.style.padding = "10px";

  const send = document.createElement("button");

  send.innerHTML = "Send";
  send.style.background = "#2563eb";
  send.style.color = "white";
  send.style.border = "none";
  send.style.padding = "10px";
  send.style.cursor = "pointer";

  inputArea.appendChild(input);
  inputArea.appendChild(send);

  box.appendChild(inputArea);


  // ============================
  // TOGGLE OPEN / CLOSE
  // ============================

  button.onclick = () => {

    box.style.display =
      box.style.display === "none"
        ? "flex"
        : "none";

  };


  // ============================
  // ADD MESSAGE FUNCTION
  // ============================

  function addMessage(text, isUser) {

    const div = document.createElement("div");

    div.innerHTML = text;

    div.style.marginBottom = "10px";
    div.style.padding = "8px";
    div.style.borderRadius = "8px";

    if (isUser) {
      div.style.background = "#2563eb";
      div.style.color = "white";
      div.style.textAlign = "right";
    } else {
      div.style.background = "#f1f5f9";
    }

    messages.appendChild(div);

    messages.scrollTop = messages.scrollHeight;

  }


  // ============================
  // SEND MESSAGE
  // ============================

  async function sendMessage() {

    const text = input.value;

    if (!text) return;

    addMessage(text, true);

    input.value = "";

    addMessage("Typing...", false);

    const typing = messages.lastChild;

    try {

      const res = await fetch(API_URL + "/chat", {

        method: "POST",

        headers: {
          "Content-Type": "application/json"
        },

        body: JSON.stringify({
          apiKey,
          message: text
        })

      });

      const data = await res.json();

      typing.remove();

      addMessage(data.reply, false);

    }
    catch {

      typing.innerHTML = "Error";

    }

  }


  send.onclick = sendMessage;

  input.addEventListener("keypress", function (e) {

    if (e.key === "Enter")
      sendMessage();

  });

})();
